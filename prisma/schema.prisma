// Prisma Schema for CloudCare Ticketing System
// Production-grade database design

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with role-based access control
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  role          Role     @default(USER)
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  createdTickets Ticket[]  @relation("TicketCreator")
  assignedTickets Ticket[] @relation("TicketAssignee")
  comments       Comment[]
  attachments    Attachment[]
  auditLogs      AuditLog[]
  refreshTokens  RefreshToken[]

  @@index([email])
  @@index([role])
  @@map("users")
}

// Refresh tokens for JWT authentication
model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Core ticket model
model Ticket {
  id            String         @id @default(uuid())
  ticketNumber  String         @unique
  title         String
  description   String         @db.Text
  priority      Priority       @default(MEDIUM)
  status        TicketStatus   @default(OPEN)
  category      String?
  tags          String[]
  
  // Relationships
  createdById   String
  createdBy     User           @relation("TicketCreator", fields: [createdById], references: [id])
  
  assignedToId  String?
  assignedTo    User?          @relation("TicketAssignee", fields: [assignedToId], references: [id])
  
  // Timestamps
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  closedAt      DateTime?
  dueDate       DateTime?
  
  // Relations
  comments      Comment[]
  attachments   Attachment[]
  auditLogs     AuditLog[]

  @@index([ticketNumber])
  @@index([status])
  @@index([priority])
  @@index([createdById])
  @@index([assignedToId])
  @@index([createdAt])
  @@map("tickets")
}

// Comments on tickets
model Comment {
  id          String   @id @default(uuid())
  content     String   @db.Text
  isInternal  Boolean  @default(false)
  
  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ticketId])
  @@index([authorId])
  @@map("comments")
}

// File attachments
model Attachment {
  id          String   @id @default(uuid())
  fileName    String
  fileSize    Int
  mimeType    String
  fileUrl     String
  
  ticketId    String?
  ticket      Ticket?  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  uploadedById String
  uploadedBy   User    @relation(fields: [uploadedById], references: [id])
  
  createdAt   DateTime @default(now())

  @@index([ticketId])
  @@index([uploadedById])
  @@map("attachments")
}

// Audit log for compliance and tracking
model AuditLog {
  id          String   @id @default(uuid())
  action      String
  entity      String
  entityId    String
  changes     Json?
  ipAddress   String?
  userAgent   String?
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  ticketId    String?
  ticket      Ticket?  @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([ticketId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Enums
enum Role {
  USER
  AGENT
  ADMIN
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  WAITING_ON_THIRD_PARTY
  RESOLVED
  CLOSED
  CANCELLED
}
